@model VNFarm.ViewModels.Admin.AdminChatViewModel
@{
    ViewData["Title"] = "Quản lý Chat";
    Layout = "_LayoutAdmin";
}

<div class="page-content">
    <div class="container-fluid">
        <div class="row">
            <div class="col-12">
                <div class="page-title-box d-sm-flex align-items-center justify-content-between">
                    <h4 class="mb-sm-0">Quản lý Chat</h4>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-body">
                        <div class="mb-4">
                            <h5 class="card-title">Danh sách các phòng chat</h5>
                            <p class="text-muted">Quản lý và hỗ trợ người dùng thông qua chat</p>
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-4">
                                <div class="input-group">
                                    <input type="text" id="searchInput" class="form-control" placeholder="Tìm kiếm...">
                                    <button class="btn btn-primary" id="searchBtn"><i class="bx bx-search"></i></button>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <select class="form-select" id="statusFilter">
                                    <option value="-999">Tất cả trạng thái</option>
                                    <option value="0">Đang xử lý</option>
                                    <option value="1">Đã đóng</option>
                                    <option value="2">Đã giải quyết</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <select class="form-select" id="typeFilter">
                                    <option value="-999">Tất cả loại</option>
                                    <option value="0">Tranh chấp vận chuyển</option>
                                    <option value="1">Chat thông thường</option>
                                    <option value="2">Tranh chấp sản phẩm</option>
                                    <option value="3">Tranh chấp thanh toán</option>
                                    <option value="4">Tranh chấp đơn hàng</option>
                                    <option value="5">Tranh chấp hoàn tiền</option>
                                    <option value="6">Tranh chấp khác</option>
                                </select>
                            </div>
                        </div>

                        <div class="table-responsive">
                            <table class="table table-hover table-nowrap mb-0">
                                <thead class="table-light">
                                    <tr>
                                        <th scope="col">ID</th>
                                        <th scope="col">Tên phòng</th>
                                        <th scope="col">Người mua</th>
                                        <th scope="col">Người bán</th>
                                        <th scope="col">Tin nhắn mới nhất</th>
                                        <th scope="col">Loại</th>
                                        <th scope="col">Trạng thái</th>
                                        <th scope="col" class="text-end">Hành động</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var room in Model.ChatRooms)
                                    {
                                        <tr>
                                            <td>#@room.Id</td>
                                            <td>@room.NameRoom</td>
                                            <td>@(room.Buyer?.FullName ?? "N/A")</td>
                                            <td>@(room.Seller?.FullName ?? "N/A")</td>
                                            <td>
                                                <div class="text-truncate" style="max-width: 200px;">
                                                    @(string.IsNullOrEmpty(room.LastMessage) ? "Chưa có tin nhắn" : room.LastMessage)
                                                </div>
                                                <small class="text-muted">@(room.LastMessageTime?.ToString("dd/MM/yyyy HH:mm") ?? "")</small>
                                            </td>
                                            <td>
                                                @switch (room.Type)
                                                {
                                                    case VNFarm.Enums.ChatRoomType.ChatNormal:
                                                        <span class="badge bg-info">Chat thường</span>
                                                        break;
                                                    case VNFarm.Enums.ChatRoomType.DisputeByShipping:
                                                        <span class="badge bg-danger">Tranh chấp vận chuyển</span>
                                                        break;
                                                    case VNFarm.Enums.ChatRoomType.DisputeByProduct:
                                                        <span class="badge bg-warning">Tranh chấp sản phẩm</span>
                                                        break;
                                                    case VNFarm.Enums.ChatRoomType.DisputeByPayment:
                                                        <span class="badge bg-danger">Tranh chấp thanh toán</span>
                                                        break;
                                                    case VNFarm.Enums.ChatRoomType.DisputeByOrder:
                                                        <span class="badge bg-warning">Tranh chấp đơn hàng</span>
                                                        break;
                                                    case VNFarm.Enums.ChatRoomType.DisputeByRefund:
                                                        <span class="badge bg-danger">Tranh chấp hoàn tiền</span>
                                                        break;
                                                    case VNFarm.Enums.ChatRoomType.DisputeByOther:
                                                        <span class="badge bg-secondary">Tranh chấp khác</span>
                                                        break;
                                                }
                                            </td>
                                            <td>
                                                @switch (room.Status)
                                                {
                                                    case VNFarm.Enums.ChatRoomStatus.InProgress:
                                                        <span class="badge bg-warning">Đang xử lý</span>
                                                        break;
                                                    case VNFarm.Enums.ChatRoomStatus.Closed:
                                                        <span class="badge bg-secondary">Đã đóng</span>
                                                        break;
                                                    case VNFarm.Enums.ChatRoomStatus.Solved:
                                                        <span class="badge bg-success">Đã giải quyết</span>
                                                        break;
                                                }
                                            </td>
                                            <td class="text-end">
                                                <a href="/Admin/Chat/Room/@room.Id" class="btn btn-sm btn-primary">
                                                    <i class="bx bx-message-square-dots"></i> Chat
                                                </a>
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>

                        @if (!Model.ChatRooms.Any())
                        {
                            <div class="text-center my-5">
                                <h5 class="text-muted">Không có phòng chat nào</h5>
                                <p>Chưa có cuộc trò chuyện nào được tạo</p>
                            </div>
                        }
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

    <script>
        $(document).ready(function() {
            // Filter functionality
            $('#searchBtn, #statusFilter, #typeFilter').on('click change', function() {
                const searchTerm = $('#searchInput').val().toLowerCase();
                const statusFilter = $('#statusFilter').val();
                const typeFilter = $('#typeFilter').val();
                
                $('tbody tr').each(function() {
                    const row = $(this);
                    const roomName = row.find('td:nth-child(2)').text().toLowerCase();
                    const buyerName = row.find('td:nth-child(3)').text().toLowerCase();
                    const sellerName = row.find('td:nth-child(4)').text().toLowerCase();
                    const lastMessage = row.find('td:nth-child(5)').text().toLowerCase();
                    
                    // Get room status and type from the badges
                    const type = row.find('td:nth-child(6) .badge').text();
                    const status = row.find('td:nth-child(7) .badge').text();
                    
                    // Check if row matches search term
                    const matchesSearch = searchTerm === '' || 
                                         roomName.includes(searchTerm) || 
                                         buyerName.includes(searchTerm) || 
                                         sellerName.includes(searchTerm) || 
                                         lastMessage.includes(searchTerm);
                    
                    // Check if row matches status filter
                    const matchesStatus = statusFilter === '-999' || 
                                        (statusFilter === '0' && status.includes('Đang xử lý')) ||
                                        (statusFilter === '1' && status.includes('Đã đóng')) ||
                                        (statusFilter === '2' && status.includes('Đã giải quyết'));
                    
                    // Check if row matches type filter
                    const matchesType = typeFilter === '-999' || 
                                       (typeFilter === '0' && type.includes('Tranh chấp vận chuyển')) ||
                                       (typeFilter === '1' && type.includes('Chat thường')) ||
                                       (typeFilter === '2' && type.includes('Tranh chấp sản phẩm')) ||
                                       (typeFilter === '3' && type.includes('Tranh chấp thanh toán')) ||
                                       (typeFilter === '4' && type.includes('Tranh chấp đơn hàng')) ||
                                       (typeFilter === '5' && type.includes('Tranh chấp hoàn tiền')) ||
                                       (typeFilter === '6' && type.includes('Tranh chấp khác'));
                    
                    // Show/hide row based on all filters
                    if (matchesSearch && matchesStatus && matchesType) {
                        row.show();
                    } else {
                        row.hide();
                    }
                });
            });
        });
    </script>