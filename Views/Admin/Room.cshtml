@model VNFarm.ViewModels.Admin.ChatRoomDetailViewModel
@{
    ViewData["Title"] = $"Chat - {Model.ChatRoom?.NameRoom}";
    Layout = "_LayoutAdmin";
}

<div class="page-content">
    <div class="container-fluid">
        <div class="row">
            <div class="col-12">
                <div class="page-title-box d-sm-flex align-items-center justify-content-between">
                    <h4 class="mb-sm-0">
                        <a href="/Admin/Chat" class="btn btn-sm btn-outline-primary me-2">
                            <i class="bx bx-arrow-back"></i>
                        </a>
                        Phòng Chat: @Model.ChatRoom?.NameRoom
                    </h4>
                    <div>
                        @switch (Model.ChatRoom?.Status)
                        {
                            case VNFarm.Enums.ChatRoomStatus.InProgress:
                                <span class="badge bg-warning">Đang xử lý</span>
                                break;
                            case VNFarm.Enums.ChatRoomStatus.Closed:
                                <span class="badge bg-secondary">Đã đóng</span>
                                break;
                            case VNFarm.Enums.ChatRoomStatus.Solved:
                                <span class="badge bg-success">Đã giải quyết</span>
                                break;
                        }
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-md-8">
                <div class="card">
                    <div class="card-body">
                        <div class="d-flex justify-content-between mb-3">
                            <h5 class="card-title mb-0">Cuộc trò chuyện</h5>
                            <div>
                                @switch (Model.ChatRoom?.Type)
                                {
                                    case VNFarm.Enums.ChatRoomType.ChatNormal:
                                        <span class="badge bg-info">Chat thông thường</span>
                                        break;
                                    case VNFarm.Enums.ChatRoomType.DisputeByShipping:
                                        <span class="badge bg-danger">Tranh chấp vận chuyển</span>
                                        break;
                                    case VNFarm.Enums.ChatRoomType.DisputeByProduct:
                                        <span class="badge bg-warning">Tranh chấp sản phẩm</span>
                                        break;
                                    case VNFarm.Enums.ChatRoomType.DisputeByPayment:
                                        <span class="badge bg-danger">Tranh chấp thanh toán</span>
                                        break;
                                    case VNFarm.Enums.ChatRoomType.DisputeByOrder:
                                        <span class="badge bg-warning">Tranh chấp đơn hàng</span>
                                        break;
                                    case VNFarm.Enums.ChatRoomType.DisputeByRefund:
                                        <span class="badge bg-danger">Tranh chấp hoàn tiền</span>
                                        break;
                                    case VNFarm.Enums.ChatRoomType.DisputeByOther:
                                        <span class="badge bg-secondary">Tranh chấp khác</span>
                                        break;
                                }
                            </div>
                        </div>

                        <!-- Chat Box -->
                        <div class="chat-box bg-light" id="chatBox" style="height: 500px; overflow-y: auto; padding: 15px; border-radius: 5px;">
                            @foreach (var chat in Model.Chats.OrderBy(c => c.CreatedAt))
                            {
                                string chatUserName = "";
                                string chatUserType = "";
                                string chatClass = "";
                                
                                if (chat.SenderId == Model.ChatRoom?.BuyerId)
                                {
                                    chatUserName = Model.BuyerInfo?.FullName ?? "Người mua";
                                    chatUserType = "Người mua";
                                    chatClass = "start";
                                }
                                else if (chat.SenderId == Model.ChatRoom?.SellerId)
                                {
                                    chatUserName = Model.SellerInfo?.FullName ?? "Người bán";
                                    chatUserType = "Người bán";
                                    chatClass = "end";
                                }
                                else
                                {
                                    chatUserName = "Admin";
                                    chatUserType = "Quản trị viên";
                                    chatClass = "center";
                                }
                                
                                <div class="message mb-3 text-@chatClass">
                                    <div class="d-flex align-items-center mb-2 justify-content-@chatClass">
                                        <div>
                                            <h6 class="mb-0">@chatUserName</h6>
                                            <small class="text-muted">@chatUserType</small>
                                        </div>
                                    </div>
                                    <div class="message-content bg-white p-3 rounded text-start d-inline-block shadow-sm">
                                        <p class="mb-0">@chat.Content</p>
                                        @if (!string.IsNullOrEmpty(chat.ImageUrl))
                                        {
                                            <div class="mt-2">
                                                <img src="@chat.ImageUrl" class="img-fluid rounded" style="max-width: 200px;" alt="Chat image" />
                                            </div>
                                        }
                                        <div class="mt-1">
                                            <small class="text-muted">@chat.CreatedAt.ToString("dd/MM/yyyy HH:mm:ss")</small>
                                        </div>
                                    </div>
                                </div>
                            }
                        </div>

                        <!-- Chat Input -->
                        @if (Model.ChatRoom?.Status != VNFarm.Enums.ChatRoomStatus.Closed)
                        {
                            <div class="chat-input mt-3">
                                <form id="chatForm" class="d-flex align-items-center">
                                    <input type="hidden" id="roomId" value="@Model.ChatRoom?.Id" />
                                    <div class="input-group">
                                        <input type="text" id="messageInput" class="form-control" placeholder="Nhập tin nhắn..." required>
                                        <button type="submit" class="btn btn-primary">
                                            <i class="bx bx-send"></i> Gửi
                                        </button>
                                    </div>
                                </form>
                            </div>
                        }
                        else
                        {
                            <div class="alert alert-warning mt-3">
                                <i class="bx bx-info-circle"></i>
                                Phòng chat này đã đóng. Không thể gửi tin nhắn mới.
                            </div>
                        }
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title mb-3">Thông tin phòng chat</h5>
                        
                        <div class="mb-3">
                            <label class="form-label fw-bold">Người mua</label>
                            <div class="d-flex align-items-center">
                                <div class="avatar me-2 bg-soft-primary">
                                    <span class="avatar-title rounded-circle text-primary">
                                        @(Model.BuyerInfo?.FullName?.Substring(0, 1) ?? "U")
                                    </span>
                                </div>
                                <div>
                                    <h6 class="mb-0">@(Model.BuyerInfo?.FullName ?? "N/A")</h6>
                                    <small class="text-muted">@(Model.BuyerInfo?.Email ?? "N/A")</small>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label fw-bold">Người bán</label>
                            <div class="d-flex align-items-center">
                                <div class="avatar me-2 bg-soft-warning">
                                    <span class="avatar-title rounded-circle text-warning">
                                        @(Model.SellerInfo?.FullName?.Substring(0, 1) ?? "S")
                                    </span>
                                </div>
                                <div>
                                    <h6 class="mb-0">@(Model.SellerInfo?.FullName ?? "N/A")</h6>
                                    <small class="text-muted">@(Model.SellerInfo?.Email ?? "N/A")</small>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label fw-bold">Mô tả</label>
                            <p class="mb-0">@(Model.ChatRoom?.Description ?? "Không có mô tả")</p>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label fw-bold">Ngày tạo</label>
                            <p class="mb-0">@(Model.ChatRoom?.CreatedAt.ToString("dd/MM/yyyy HH:mm:ss") ?? "N/A")</p>
                        </div>

                        @if (Model.ChatRoom?.OrderId != null)
                        {
                            <div class="mb-3">
                                <label class="form-label fw-bold">Đơn hàng liên quan</label>
                                <p class="mb-0">
                                    <a href="/Admin/Orders/Detail/@Model.ChatRoom.OrderId" class="btn btn-sm btn-outline-primary">
                                        <i class="bx bx-package"></i> Xem đơn hàng #@Model.ChatRoom.OrderId
                                    </a>
                                </p>
                            </div>
                        }
                        
                        <div class="mt-4">
                            <h5 class="card-title mb-3">Quản lý phòng chat</h5>
                            
                            <div class="d-grid gap-2">
                                @if (Model.ChatRoom?.Status == VNFarm.Enums.ChatRoomStatus.InProgress)
                                {
                                    <button class="btn btn-success" id="btnSolve">
                                        <i class="bx bx-check-circle"></i> Đánh dấu đã giải quyết
                                    </button>
                                    <button class="btn btn-secondary" id="btnClose">
                                        <i class="bx bx-x-circle"></i> Đóng phòng chat
                                    </button>
                                }
                                else if (Model.ChatRoom?.Status == VNFarm.Enums.ChatRoomStatus.Closed || 
                                        Model.ChatRoom?.Status == VNFarm.Enums.ChatRoomStatus.Solved)
                                {
                                    <button class="btn btn-warning" id="btnReopen">
                                        <i class="bx bx-refresh"></i> Mở lại phòng chat
                                    </button>
                                }
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="~/lib/signalr/signalr.min.js"></script>
    <script>
        $(document).ready(function() {
            const roomId = $('#roomId').val();
            
            // Scroll to bottom of chat box
            function scrollToBottom() {
                const chatBox = document.getElementById('chatBox');
                chatBox.scrollTop = chatBox.scrollHeight;
            }
            
            // Scroll to bottom initially
            scrollToBottom();
            
            // Connect to SignalR hub
            const connection = new signalR.HubConnectionBuilder()
                .withUrl("/chatHub?roomId=" + roomId + "&access_token=" + getCookie("jwt"))
                .build();
                
            // Receive message from hub
            connection.on("ReceiveMessage", function(senderId, message) {
                // Get current date time
                const now = new Date();
                const dateTimeStr = now.toLocaleDateString() + " " + now.toLocaleTimeString();
                
                // Create message element
                const messageHtml = `
                    <div class="message mb-3 text-center">
                        <div class="d-flex align-items-center mb-2 justify-content-center">
                            <div>
                                <h6 class="mb-0">Admin</h6>
                                <small class="text-muted">Quản trị viên</small>
                            </div>
                        </div>
                        <div class="message-content bg-white p-3 rounded text-start d-inline-block shadow-sm">
                            <p class="mb-0">${message}</p>
                            <div class="mt-1">
                                <small class="text-muted">${dateTimeStr}</small>
                            </div>
                        </div>
                    </div>
                `;
                
                // Append message to chat box
                $('#chatBox').append(messageHtml);
                
                // Scroll to bottom
                scrollToBottom();
            });
            
            // Start connection
            connection.start()
                .then(function() {
                    console.log("Connected to chat hub");
                })
                .catch(function(err) {
                    console.error(err.toString());
                });
            
            // Send message
            $('#chatForm').on('submit', function(e) {
                e.preventDefault();
                
                const message = $('#messageInput').val();
                if (message.trim() === '') return;
                
                connection.invoke("SendMessage", roomId, message)
                    .catch(function(err) {
                        console.error(err.toString());
                    });
                
                $('#messageInput').val('');
            });
            
            // Room management
            $('#btnSolve').on('click', function() {
                updateRoomStatus(roomId, 2); // Solved
            });
            
            $('#btnClose').on('click', function() {
                updateRoomStatus(roomId, 1); // Closed
            });
            
            $('#btnReopen').on('click', function() {
                updateRoomStatus(roomId, 0); // In Progress
            });
            
            function updateRoomStatus(roomId, status) {
                $.ajax({
                    url: '/api/ChatRoom/' + roomId + '/status',
                    type: 'PUT',
                    data: JSON.stringify(status),
                    contentType: 'application/json',
                    headers: {
                        'Authorization': 'Bearer ' + getCookie('jwt')
                    },
                    success: function() {
                        window.location.reload();
                    },
                    error: function(xhr) {
                        alert('Lỗi khi cập nhật trạng thái phòng chat: ' + xhr.responseText);
                    }
                });
            }
            
            // Helper function to get cookie
            function getCookie(name) {
                const value = `; ${document.cookie}`;
                const parts = value.split(`; ${name}=`);
                if (parts.length === 2) return parts.pop().split(';').shift();
            }
        });
    </script>
} 